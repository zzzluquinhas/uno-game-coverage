name: Testes e Cobertura de C贸digo

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: 猬锔 Checkout do C贸digo
      uses: actions/checkout@v4

    - name: 锔 Instalar gcovr e depend锚ncias de C++
      run: |
        sudo apt-get update
        sudo apt-get install -y gcovr build-essential

    # O diret贸rio de trabalho agora 茅 definido para ./test
    - name:  Compilar e Linkar (make clean, make link)
      working-directory: ./test
      run: |
        echo "Executando make clean e make link dentro de ./test"
        make clean
        make link

    # O diret贸rio de trabalho 茅 mantido em ./test
    - name: 讹 Rodar Testes (make run) e Verificar Sucesso
      working-directory: ./test
      run: |
        # Executa o make run (que deve gerar o ./PALIO no diret贸rio de build)
        # E salva a sa铆da para inspe莽茫o
        make run 2>&1 | tee test_output.log
        
        # Verifica se o doctest reportou sucesso
        if grep -q "Status: SUCCESS!" test_output.log; then
          echo "Testes do Doctest executados com sucesso!"
        else
          echo "ERRO: Testes do Doctest falharam ou o status n茫o foi encontrado."
          exit 1
        fi
        
    # O comando gcovr deve ser capaz de localizar os arquivos de cobertura
    # usando os caminhos relativos ao diret贸rio onde o make run foi executado.
    - name:  Gerar Relat贸rio de Cobertura (gcovr)
      working-directory: ./test
      run: |
        # O comando gcovr usa caminhos relativos ao diret贸rio atual (./test)
        # Para acessar o diret贸rio de build (../build) e os arquivos fonte (../src/objects)
        echo "Gerando resumo de cobertura..."
        gcovr --print-summary ../build -r ../src/objects --exclude "../src/objects/menuInicial.cpp" --exclude "../src/objects/menuAjuda.cpp"
        
        # Opcional: Gerar um relat贸rio XML para publica莽茫o
        gcovr --xml --output coverage.xml ../build -r ../src/objects --exclude "../src/objects/menuInicial.cpp" --exclude "../src/objects/menuAjuda.cpp"

    # --- Etapa Opcional: Publicar o Relat贸rio de Cobertura ---
    - name:  Publicar Cobertura
      uses: codecov/codecov-action@v4
      with:
        # O arquivo coverage.xml deve estar em ./test/coverage.xml
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./test/coverage.xml
        fail_ci_if_error: true

        
